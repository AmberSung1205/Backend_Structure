# CSC0425 列印發送特殊運價差異表
---
# 目錄
[ToC]
# :memo: 畫面欄位
| 欄位名稱                | 處 理 說 明                                                                                                                                                                                                    |
| ----------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 發送日期 <br/> &DM0101  | 1. 必要輸入欄位 。<br/>2.	預設系統日期 <br/>3.	格式為民國年月日(YYY/mm/dd)) 。<br/>4.	使用者輸入 (檢核是否為有效日期) 。<br/>5.	使用者自行輸入或點選圖示選取日期，不可空白 。                                  |
| 列印所站  <br/> &DM0102 | 1. 必要輸入欄位 。<br/>2.使用者自行輸入或點選圖示選取資料  。 <br/>3.所站代號需再帶出所站名稱(例：7048-松山)  。<br/>4.	9999表全部 。                                                                          |
| 含併筆   <br/> &OPT1    | 1. 下拉式選單 。<br/>2.1-Y 2-N 。 <br/>3.預設N 。                                                                                                                                                              |
| 所站  <br/> LSTN        | 1.必要輸入欄位 。<br/>2.	使用者自行輸入或點選圖示選取資料，不可空白 。 <br/>3.所站代號需再帶出所站名稱(例：7048松山) 。<br/>4.如是營業所人員登入，需將此欄位帶入營業所人員所屬所站代號，如不是開放可以輸入  。 |


# :memo: 程式邏輯

## 主程式
<hr>

### :pushpin: Step 1: 發送日期若為系統日，執行CSC028計算運價不符。

### :pushpin: Step  2: 發送日期小於系統日，執行CSR0425，下載CSF021資料。
<br/><br/>

## :pushpin: Step 1  列印發送資料特殊運價差異表(CSC028)
---
#### 資料表
| Name   | Text                   | Lib         |
| ------ | ---------------------- | ----------- |
| CSF01  | 發送明細檔             | ZDF所站代碼 |
| CEFC2  | 物流客戶運價主控檔     | ZDFLIB      |
| ZDF201 | 所站代號主檔           | ZDFLIB      |
| ZDF272 | 運價表明細檔           | ZDFLIB      |
| CSF46  | 路線客戶約價檔         | ZDFLIB      |
| CSF11  | 特殊服務費及區外送費檔 | ZDFLIB      |
| ZDF25B | 所站簡碼及區域檔       | ZDFLIB      |
| SBF52  | 路線大B客戶資料檔      | ZDFLIB      |

#### 報表欄為(CSW28)
| Name   | Text           |
| ------ | -------------- |
| WS2801 | 發站集序號     |
| WS2802 | 到站集序號     |
| WS2803 | 貨號           |
| WS2804 | 明細單編號     |
| WS2805 | 托運人名稱     |
| WS2806 | 收貨人         |
| WS2807 | 支付方式       |
| WS2808 | 運費選擇       |
| WS2809 | 件數           |
| WS2810 | 重量           |
| WS2811 | 原訂運費       |
| WS2812 | 原訂接費       |
| WS2813 | 原訂送費       |
| WS2814 | 電腦運費       |
| WS2815 | 電腦接費       |
| WS2816 | 電腦送費       |
| WS2817 | 更正單號及說明 |
| WS2818 | 每件或代款額   |
| WS2819 | 差異運費       |
| WS2820 | 差異接費       |
| WS2821 | 差異送費       |
| WS2822 | 運             |
| WS2823 | 接             |
| WS2824 | 送             |
| ReportNo | 報表編號     |
| ReportStation | 報表站所 |
| ReportDate | 製表日期   |
| ReportTime | 製表時間   |
| COUNT | 差異筆數   |
| SUBTTT | 差異金額   |

#### 依發送日期查詢發送明細
#### 1.資料來源:

#### :arrow_down: 判斷&DM0102是否為9999   
* Y: 全部列印 

    (&DM0102 = 9999):
~~~~sql
    SELECT *
    FROM ZDF7048.CSF01 S7048
    WHERE S7048.CS0102 發送日期 = &DM0101 發送日期
    UNION ALL 
    SELECT *
    FROM ZDF5150.CSF01 S5150
    WHERE S5150.CS0102 發送日期 = &DM0101 發送日期
    ...
    /*取得所有站所的發送明細*/
~~~~

* N: 部分列印 
    (&DM0102 <> 9999):
~~~~sql
    Select * 
    from CSF01發送明細檔 (ZDF站所)
    where CSF01.CS0102發送日期 = &DM0101 發送日期
    AND   CSF01.CS0107發送站 = &DM0102 發送站
~~~~
#### :arrow_down: 資料過濾
   
* 併筆判斷(&OPT1)
    不含併筆(&OPT1 = N) ， 請排除以下資料:
~~~~sql
    WHERE CS0116 NOT IN (
    Select CEC201 
    from CEFC2  /*物流客戶運價主控檔*/
    where CEC205 = 'Y')
~~~~

#### 2.檢核支付方式(CHKDAT):
- #### 執行運價差異檢核條件
  1. 支付方式(CS0126)為現付
  2. 非現付的運價選擇(CS0127)要為'13'
  3. 運價選擇非為'13'，運價選擇要大於等於'16'
>
~~~~sql
    If( CSF01.CS0126 == '1'){

        *執行運價差異檢核(PROC1)

    }else If(CSF01.CS0127 == '13'){

        *執行運價差異檢核(PROC1)

    }else If(CSF01.CS0127 >= '16'){

        *執行運價差異檢核(PROC1)

    }else{}
~~~~

#### 3.運價差異檢核(PROC1):
##### 暫存欄位初始化
| Name     | Data            | Text         |
| -------- | --------------- | ------------ |
| WEGHTP   | 0               | 重量         |
| WS0236   | 空白            | 運費下限否   |
| AGTCH    | CS0141(取前3碼) | 折扣         |
| WS0505   | 0               | 底價折扣     |
| AGTCHP   | 0               | 底價         |
| TCHRGP   | 0               | 原訂運費     |
| TCHRG1   | 0               | 電腦運費     |
| TCHRG2   | 0               | 差異運費     |
| RCFEEP   | 0               | 原訂接費     |
| RCFEE1   | 0               | 電腦接費     |
| RCFEE2   | 0               | 差異接費     |
| SNFEEP   | 0               | 原訂送費     |
| SNFEE1   | 0               | 電腦送費     |
| SNFEE2   | 0               | 差異送費     |
| PCKERP   | 0               | 送捆工費     |
| CSHFRP   | 0               | 代款         |
| TCHRGT   | 空白            ||
| RCFEET   | 空白            ||
| WBAS     | 0               | 原始底價     |
| CHKL80   | 0               | 運費判斷類別 |
| CHKL81   | 0               | 運費判斷類別 |
| CHKL84   | 0               | 運費判斷類別 |
| CHKL85   | 0               | 運費判斷類別 |
| CHKL86   | 0               | 運費判斷類別 |
| CHKL87   | 0               | 運費判斷類別 |
| CHKL88   | 0               | 運費判斷類別 |
| CHKL89   | 0               | 運費判斷類別 |

~~~~sql
WEGHTP = CASE WHEN  CSF01.CS0123 > (CSF01.CS0124*10) THEN CSF01.CS0123 ELSE CSF01.CS0124*10 END
~~~~

####找運價檔
~~~~sql
Select * 
From ZDF272
WHERE F27201 = (
SELECT 
CASE WHEN F20116 != 0 THEN F20101 ELSE F20107 END
FROM ZDF201 WHERE F20101 = CSF01.CS0107 發送站
) AND F27202 = CSF01.CS0108 到著站 AND F27200 = 'A'
~~~~

####:arrow_down:   無運價檔
~~~~sql

CHKL89 = 1;

*Func : 列印差異表(SUBPRT)
~~~~
####:arrow_down:有運價檔



#### 運費處理(FRESR)

> ##### A.查詢路線客戶約價檔ZDFLIB/CSF46
> ~~~~sql
>Select * From CSF46
>Where CSF46.CS4602/*單位代號*/ = &LSTN --登入站所代號
>AND CSF46.CS4601 /*客戶編號*/ = CSF01.CS0116 --託運人編號
>~~~~
>>A.1若有客戶約價資料:
>> ~~~~sql
>>If( &DM0101 >= CSF46.CS4618 && &DM0101 <= CSF46.CS4619){
>>  WS0236 = CSF46.CS4624 ;    --異動底價限制
>>}
>>If( &DM0101 >= CSF46.CS4628 && &DM0101 <= CSF46.CS4629){
>>  WS0236 = CSF46.CS4624 ;    --異動底價限制
>>}
>>
>>~~~~
>

> ##### B.客編是否為杏輝(93061042)
>~~~~sql
>WS0505 = (ZDF272.F27206 * AGTCH) / 100; --底價折扣
>
>/*非杏輝*/
>If( CSF01.CS0116 != '93061042' ){ 
>   If( WS0236 != 'Y' && AGTCHP < ZDF272.F27205 /*百公斤*/){ --運費有下限
>
>       AGTCHP = ZDF272.F27206; --底價 
>
>   }else{ --運費無下限
>      If( AGTCHP < WS0505){
>
>       AGTCHP = WS0505; --底價折扣  
>
>      } 
>   }  
>}
>/*杏輝*/
>else { 
>   If( AGTCH == '' ){ --無折扣
>       If( WS0236 != 'Y' && AGTCHP < ZDF272.F27206 /*底價*/){ --運費有下限
>           AGTCHP = ZDF272.F27206; --底價
>       }else{ --運費無下限
>         If( AGTCHP < WS0505){
>            AGTCHP = WS0505; --底價折扣  
>         }
>   }else{ --有折扣
>       AGTCHP = (((WEGHTP * ZDF272.F27205)/100)*AGTCH) / 100 ;
>   }
>}
>
>
>TCHRG1 = AGTCHP --電腦運費
>TCHRGP = CSF01.CS0128 /*運費*/ + CSF01.CS0144/*報值運費*/  --原訂運費
>
>If( TCHRG1 >= CHRGP ){ --已含報值費
>    TCHRG2 = TCHRG1 - TCHRGP
>}
>else{
>    CHKL85 = 1 ;
>    TCHRGT = '****';
>}
>
>
>~~~~

    
#### 接費處理(RCFSR)
>##### A.系統接費
>~~~~sql
>/*特輸服務費及區外送費檔*/
>Select * from CSF11
>Where CS1100 = 'B'
>AND CS1101 = '05'
>
>有值: WBAS = CSF11.CS1112 ; --原始底價
>~~~~
>>A.1若有特輸服務費及區外送費:
>> ~~~~sql
>> WBAS = CSF11.CS1112 ; --原始底價
>>~~~~
>>A.2沒有特輸服務費及區外送費:
>> ~~~~sql
>> WBAS = 27 ;
>>~~~~


>##### B.接費計算
>~~~~sql
>/*支付方式為1 ,或運費選擇為13*/
>If(CSF01.CS0126 == '1'|| CSF01.CS0127 == '13'){   
>   If(CSF01.CS0129/*接費*/ != 0){
>
>       /*為7250大坪、6157永和 */
>       If(CSF01.CS0107 == '7250' || CSF01.CS0107 == '6157'){
>           /*集貨站(RCFSR3)*/
>           AGRCFP = CSF01.CS0129; --接費     
>
>           *Func:接費差額(RCFSRA)
>
>       }
>       else{
>    
>           *Func:接費非零或 16 17(RCFSR9)
>
>           *Func:接費差額(RCFSRA)
>
>       }
>    }
>    else{
>       /*現收接費為零(RCFSR0)*/
>       RCFEEP = CS0129	--接費
>       RCFEE1 = CS0129	
>       RCFEE2 = CS0129	   
>    }
>}
>else{
>
>   /*非杏輝*/
>   If( CSF01.CS0116 != '93061042' ){ 
>
>       *Func:接費非零或 16 17(RCFSR9)
>
>       *Func:接費差額(RCFSRA)  
>
>   }
>   /*杏輝*/
>   else { 
>      If( AGTCH == '' ){ --無折扣
>
>       *Func:接費非零或 16 17(RCFSR9)
>
>      }else{
>       
>         If( AGTCH == '000' ){ --無接費
>
>           AGRCFP = 0 ;
>           *Func:接費非零或 16 17(RCFSR9)
>   
>         }else{ --有折扣
>           AGRCFP = (((WEGHTP*35)/100)*30)/100;
>           *Func:接費差額(RCFSRA)  
>         }
>      }
>   }
>}
>
>~~~~

>##### C.搬運費(接費)(CHKRCF)
>~~~~sql
>OK = 'Y';
>~~~~
>
>##### C.1 路線大B客戶資料檔
>~~~~sql
>
>Select * from SBF52 
>where SBF52.SB5201/*客戶編號*/ = CSF01.CS0116 /*託運人編號*/
>~~~~
>>~~~~sql
>>有資料 : 
>>OK = 'N';
>>~~~~
>##### C.2 排除客編 08 、 12 、 17 、 34
>~~~~sql
>If(CNO12 == '08' || CNO12 == '12' || CNO12 == '17' || CNO12 == '34' ){
>    OK = 'N';
>}
>~~~~
>##### C.3 集貨站區別
>~~~~sql
>Select * from ZDF201所站代號明細檔
>Where ZDF201.F20101 /*單位代號*/ = CSF01.CS0107/*發站*/
>}
>~~~~
>>~~~~sql
>>有資料 :
>>If(ZDF201.F20138/*路線識別*/ !='5') {
>>    OK = 'N';
>>}
>>~~~~
>##### C.4 搬運費-排除永康集&義大集
>~~~~sql
>If(CSF01.CS0107 =='6386'|| CSF01.CS0107 =='8958'){
>    OK = 'N';
>}
>~~~~
>##### C.5 運選碼：自送
>~~~~sql
>If(CSF01.CS0127 !='05' /*運費選擇*/&& CSF01.CS0127 !='06' /*運費選擇*/ && CSF01.CS0127 !='08' /*運費選擇*/ ){
>    OK = 'N';
>}
>~~~~
>##### C.6 開始上線日：發送日≧1031201
>~~~~sql
>If(CS0102 <= 1031201){
>    OK = 'N';
>}
>~~~~
>~~~~sql
>If(OK=='Y'){
>    RCFEE1 = CSF01.CS0122 * 10 ;
>}
>~~~~
>~~~~sql
>RCFEEP = CSF01.CS0129 /*接費*/
>~~~~
>~~~~sql
>If(RCFEE1 >= RCFEEP){
>    RCFEE2 = RCFEE1 - RCFEEP  ;
>}else{
>    CHKL86 = 1 ;
>    RCFEET = '****' ;   
>}
>~~~~




#### 檢核備註(OTHSR)
>~~~~sql
>SNFEED = CSF01.CS0130 ; --送費
>
>If(CS0137 != '3'){  --備註
>   *Func:檢核代款(CHKCSH)
>}  
>elae{
>   SNFEEP = CSF01.CS0130 ;   
>   If(SNFEED != 0){
>       *Func : 送費及挽工費計算(SNFSR)
>   }else{
>       CHKL87 = 1 ;
>       SNFEET = '止' ;
>   }
>}
>
>~~~~
>


#### 檢核付款人編號(CHKSND)
~~~~sql
If(CSF01.CS0116 !='00000000'){ 

    *Func : 檢核每件運價 (CHKGPS)

}
else{
    
    *Func : 檢核運價合計差異是否＞0及代款是否＜30 (CHKSUB)

}

~~~~

### 4.列印發送資料特殊運價差異表(CSR0291)
#### 檔名
&YMD8(民國年月日) + '運價差異'.csv
<br/>

#### 表頭(HEAD)
| 報表欄位| 欄位值 |
| ----| ------ |
| 報表編號 |  'CS028'      | 
| 列印報表站所 |  &LSTN       | 
| 報表名稱 |   '發送資料特殊運價差異表'| 
| 製表日期 | 當下日期 | 
| 製表時間 |  當下時間  | 
| 發送日期 |    &DM0101      | 

<br/>

#### 表身(DTL)
| 報表欄位| 欄位值 |
| ----| ------ |
| 發站 |  SNSTNP      | 
| 到站 |  RCSTNP      | 
| 明細單號 |   WS2803 + WS2804| 
| 托運人名稱 | WS2805 | 
| 收貨人 |  WS2806  | 
| 支付 |    PCODEP  | 
| 運選 |    WS2808 | 
| 件數 | WS2809     | 
| 重量 |    WS2810    | 
| 原訂運費 |  WS28111  | 
| 原訂接費 |  WS28121                  | 
| 原訂送費 |  WS28131                  | 
| 電腦運費 |  WS28141                  | 
| 電腦接費 |  WS28151                  | 
| 電腦送費 |  WS28161                  |
| 差異運費 |  WS28191                  | 
| 差異接費 |  WS28201                  | 
| 差異送費 |  WS28211                  |
| 更正單號及說明： |  WS28182 + WS2818  |

##### 1. 如果有差異資料，則執行:

> ##### *Func : 列印差異表(SUBPRT_2)

>~~~~sql
>WS28111 = WS28111 ;
>WS28112 = WS28121 ;
>WS28113 = WS28131 ;
>WS28114 = WS28141 ;
>WS28115 = WS28151 ;
>WS28116 = WS28161 ;
>WS28119 = WS28191 ;
>WS28120 = WS28201 ;
>WS28121 = WS28201 ;
>
>If( CHKL84 == 1 ){ WS28141 = '****' }
>If( CHKL89 == 1 ){ WS28141 = '????' }
>If( CHKL84 == 1 ){ WS28151 = '****' }
>If( CHKL89 == 1 ){ WS28151 = '????' }
>If( CHKL84 == 1 ){ WS28161 = '****' }
>If( CHKL89 == 1 ){ WS28161 = '????' }
>If( CHKL85 == 1 ){ WS28191 = '****' }
>If( CHKL89 == 1 ){ WS28191 = '????' }
>If( CHKL86 == 1 ){ WS28201 = '****' }
>If( CHKL89 == 1 ){ WS28201 = '????' }
>If( CHKL81 == 1 ){ WS28211 = '止' }
>If( CHKL87 == 1 ){ WS28211 = '****' }
>If( CHKL89 == 1 ){ WS28211 = '????' }
>
>WS28182 = '' ;
>If( CHKL88 == 1 ){ WS28182 = '代款' }
>If( CHKL84 == 1 ){ WS28182 = '每件' }
>If( CHKL89 == 1 ){ WS28182 = '檔不存在' }
>
>~~~~
>![](https://i.imgur.com/yPIth14.png)
<br/>

##### 2. 無差異資料，則執行 : 
> ##### 顯示"無任何差異資料"
>![](https://i.imgur.com/bMT4GS0.png)
<br/>

<br/>
#### 表尾(TAIL)
| 報表欄位| 欄位值 |
| ----| ------ |
| 差異筆數 |  COUNT      | 
| 差異金額 |  SUBTTT     | 

<br/>

### *Func :
---
##### 接費差額(RCFSRA)
>~~~~sql
>RCFEE1 = AGRCFP;      --電腦接費
>RCFEEP = CSF01.CS0129;--原訂接費
>
>If(RCFEE1>= RCFEEP){
>   RCFEE2=RCFEE1-RCFEEP;
>}else{
>   CHKL86 = 1 ;
>   RCFEET='****';
>}
>
>~~~~

##### 接費非零或 16 17(RCFSR9)
>~~~~sql
>AGRCFP = (WEGHTP*35)/100;
>If(AGRCFP < WBAS){
>    AGRCFP = WBAS;
>}
>
>~~~~

##### 送費及挽工費計算(SNFSR)
>~~~~sql
>SNFEEB = (WEGHTP*35)/100;
>If(SNFEEB < WBAS){
>    SNFEEB = WBAS;
>}
>
>SNFEE1 = SNFEEB ;
>SNFEEP = CSF01.CS0130 ;
>PCKERB = 0;
>
>If( YMD < 981299 && CSF01.CS0108 == '7005'){
>   PCKERB =  (WEGHTP*10) / 100 ;
>
>   If(PCKERB< 6){
>       PCKERB = 6 ;
>   }
>}
>
>PCKERP = CS0132 ; --送捆工費
>SNFEE1 = SNFEE1 + PCKERB ;
>SNFEEP = SNFEES + SNFEEP ;
>
> *Func:特殊服務費(SR1000)
>
>If(SVAMT1 >= SVAMT2){
>   SVAMTC = SVAMT1 ;
>}else{
>   SVAMTC = SVAMT2 ;
>}
>
>/*電腦計算的送費＋電腦計算的特殊服務費*/
>SNFEE1 = SNFEE1 + SVAMTC ;
>/*人工輸入的送費＋人工輸入的特殊服務費*/
>SNFEEP	= SNFEEP + CS0163;--特服費
>TCHRGP = CS0144 ;         --報值費
>
>If(SNFEE1 >= SNFEEP){
>    SNFEE2 = SNFEE1 - SNFEEP;
>}else{
>    CHKL87 = 1 ;
>    SNFEET = '****';
>}
>
>~~~~

##### 特殊服務費(SR1000)
>~~~~sql
>If(CS0145 >= '01'){
>
>   Select * from CSF11 --特殊服務費及區外送費檔
>   Where CSF11.CS1100 = 'A' --識別碼(A特殊服務費B區)
>   And CSF11.CS1101 = CSF01.CS0145 --特服碼1
>   
>   ▲ 有特殊服務費及區外送費，
>     執行 : 
>            *Func:取正確的特殊服費之百公斤及底價(SR1010) 
>            *Func:計算電腦的特殊服務費(SR1020)
>
>}
>else{
>   SVAMT1 = 0;
>}
>
>SVCO2T = CS0147特服碼２
>
>If(CS0145 >= '03'){
>
>   Select * from CSF11 --特殊服務費及區外送費檔
>   Where CSF11.CS1100 = 'A' --識別碼(A特殊服務費B區)
>   And CSF11.CS1101 = CSF01.CS0147 --特服碼2
>   
>   ▲ 有特殊服務費及區外送費，
>     執行 : 
>            *Func:取正確的特殊服費之百公斤及底價(SR1010)
>            *Func:計算電腦的特殊服務費(SR1020)
>
>}
>else{
>   SVAMT2 = 0;
>}
>
>~~~~

##### 取正確的特殊服費之百公斤及底價(SR1010) 
>~~~~sql
>    
>If(CSF11.CS0102/*發送日期*/ >= CSF11.CS1114/*原始有效日起*/&& CSF11.CS0102/*發送日期*/ <= CSF11.CS1115/*原始有效日起*/){
>   TKILO = CS1111 ;    --原始百公斤
>   TPRICE = CS1112;    --原始底價
>}
>If(CSF11.CS0102/*發送日期*/ >= CSF11.CS1124/*異動有效日起*/&& CSF11.CS0102/*發送日期*/ <= CSF11.CS1125/*異動有效日起*/){
>   TKILO = CS1111 ;    --原始百公斤
>   TPRICE = CS1112;    --原始底價   
>}
>
>~~~~

##### 計算電腦的特殊服務費(SR1020)
>~~~~sql
>    
> SVAMTA = WEGHTP * TKILO ;
> SVAMTB = SVAMTA / 100;   
>
>If(SVAMTB< TPRICE){
>    SVAMTB = TPRICE ; 
>}
>
>SVAMT1 = SVAMTB;
>
>~~~~

##### 計算按件計價的運什費(CSR0284)
>##### 帶入參數:
>|    Name    | Field | Text
>| :----------: | :---------: |:-------: 
>| STN1 |  LSTN |發站
>| STN2 |  CSF01.CS0108 |到站
>| DYMD8 | &DM0101  | 發送日
>| NO08 |  CSF01.CS0116 |客戶編號
>| GX04 |  0 |每件運費
><br/>
>
>##### 執行:
>#####  *Func : 計價＋區域 (SR1100)
><br/>



##### 計價＋區域 (SR1100)
>##### 1.發站
>~~~~sql    
>Select * from ZDF201 --所站代號主檔 
>where ZDF201.F20101 = STN1 --發站
>~~~~
>>###### 所站代號主檔中有資料，則執行: 
>>~~~~sql  
>>STN1 = F20107 ;
>>~~~~
>
>##### 2.到站
>~~~~sql    
>If(STN2 != '6513'/*埔里*/){
>~~~~
>>~~~~sql  
>>Select * from ZDF201  --所站代號主檔 
>>where ZDF201.F20101 = STN2 --到站
>>~~~~
>>###### 所站代號主檔中有資料，則執行: 
>>~~~~sql  
>>STN2 = F20107 ;
>>~~~~
>~~~~sql  
>}
>~~~~
>
>##### 3.區域
>~~~~sql    
>X25B11 = 空白 ;
>~~~~
>~~~~sql  
>Select * from ZDF25B --所站簡碼及區域檔
>where ZDF25B.F15B01 = STN2 --到站
>~~~~
>>###### 所站簡碼及區域檔中有資料，則執行: 
>>~~~~sql  
>>X25B11 = F25B11 ; --按件區域(1-北區、2-中區、3-南區、4-宜羅、5-花東)
>>
>>*Func : 按件客戶 - 判定有效期間(SR1200)
>>
>>~~~~


##### 按件客戶 - 判定有效期間(SR1200)
>~~~~sql
>If(NO08 > '00000000') {      --有客戶編號
>~~~~
>>~~~~sql
>>Select * from CSF46        --路線客戶約價檔
>>Where CSF46.CS4601 = NO08  --客戶編號
>>AND CSF46.CS4602 = STN1    --使用站所
>>~~~~
>> ###### 有路線客戶約價，則執行: 
>>~~~~sql
>>FE01 = 0 ; --每件運費
>>If(CSF46.CS4666 != ''){ --按件約價識別 (原始)
>>    *Func : 原始按件計價基準(SR1210)
>>}
>>    
>>If(CSF46.CS4686 != ''){ --按件約價識別 (異動)
>>    *Func : 異動按件計價基準(SR1220)
>>}
>>~~~~
>~~~~sql
>}
>~~~~


##### 檢核代款(CHKCSH)
>~~~~sql
>If(NO08 > '00000000') {      --有客戶編號
>   CSHFRD = CSF01.CS0133 --代款
> 
>   If(CSHFRD == 0){
>         *Func : 送費及挽工費計算(SNFSR)
>   }else{
>       If(SNFEED != 0){
>         *Func : 送費及挽工費計算(SNFSR)
>       }
>   }
> }
> 
> 
> 
> 
> 
> 
> 
> }
> 
> }
> 
>~~~~


##### 原始按件計價基準(SR1210)
>~~~~sql
>/*發送日*/
>If( DYMD8 >= CSF46.CS4668/*原始開始日期*/ && DYMD8 <= CSF46.CS4669 /*原始結束日期*/ ){
>   /*按件約價識別(原始)*/
>   If ( CSF46.CS4666 == 'T' ){  --全區 
>       FE01 /*每件運費*/ = CSF46.CS4651 ; --按件全部運價
>   }    
>   /*按件約價識別(原始)*/
>   If ( CSF46.CS4666 == 'Y' ){ --分區
>       /*每件運費*/
>       switch (X25B11)
>       {  /*每件運費*/
>          case 1: --北區
>              FE01=CS4654      --按件北區運價                         
>              break;
>          case 2: --中區
>              FE01 = CS4657    --按件中區運價
>              break;
>          case 3: --南區
>              FE01 = CS4660    --按件南區運價
>              break;
>          case 4: --宜羅
>             FE01 = CS4663     --按件宜羅運價
>              break;
>          case 5: --花東
>              FE01 = CS46C1    --按件花東運價
>              break;
>          default:
>              break;
>       }
>
>       If(FE01 > 0) { --約價區域
>           GX04 = FE01 ;
>       }
>
>    } 
>}
>
>
>~~~~

##### 異動按件計價基準(SR1220)
>~~~~sql
>/*發送日*/
>If( DYMD8 >= CSF46.CS4688/*異動開始日期*/ && DYMD8 <= CSF46.CS4689 /*異動結束日期*/ ){
>    /*按件約價識別(異動)*/
>   If ( CSF46.CS4686 == 'T' ){  --全區 
>       FE01 /*每件運費*/ = CSF46.CS4671 ; --按件全部運價
>   }    
>   /*按件約價識別(異動)*/
>   If ( CSF46.CS4686 == 'Y' ){ --分區
>       /*每件運費*/
>       switch (X25B11)
>       {  
>          case 1: --北區
>              FE01=CS4674      --按件北區運價                         
>              break;
>          case 2: --中區
>              FE01 = CS4677    --按件中區運價
>              break;
>          case 3: --南區
>              FE01 = CS4680    --按件南區運價
>              break;
>          case 4: --宜羅
>             FE01 = CS4683     --按件宜羅運價
>              break;
>          case 5: --花東
>              FE01 = CS46E1    --按件花東運價
>              break;
>          default:
>              break;
>       }
>
>       If(FE01 > 0) { --約價區域
>           GX04 = FE01 ;
>       }
>
>    } 
>}    
>
>~~~~


##### 原始按件計價基準(SR1210)
>~~~~sql
>/*發送日*/
>If( DYMD8 >= CSF46.CS4668/*原始開始日期*/ && DYMD8 <= CSF46.CS4669 /*原始結束日期*/ ){
>   /*按件約價識別(原始)*/
>   If ( CSF46.CS4666 == 'T' ){  --全區 
>       FE01 /*每件運費*/ = CSF46.CS4651 ; --按件全部運價
>   }    
>   /*按件約價識別(原始)*/
>   If ( CSF46.CS4666 == 'Y' ){ --分區
>       /*每件運費*/
>       switch (X25B11)
>       {  /*每件運費*/
>          case 1: --北區
>              FE01=CS4654      --按件北區運價                         
>              break;
>          case 2: --中區
>              FE01 = CS4657    --按件中區運價
>              break;
>          case 3: --南區
>              FE01 = CS4660    --按件南區運價
>              break;
>          case 4: --宜羅
>             FE01 = CS4663     --按件宜羅運價
>              break;
>          case 5: --花東
>              FE01 = CS46C1    --按件花東運價
>              break;
>          default:
>              break;
>       }
>
>       If(FE01 > 0) { --約價區域
>           GX04 = FE01 ;
>       }
>
>    } 
>}
>
>
>~~~~


##### 列印差異表(SUBPRT)
>~~~~sql
>Select * from ZDF201 
>where ZDF201.F20101/*站所代號*/ = CSF01.CS0107 --發站
>~~~~
>>有站所資料:
>>~~~~sql
>>WS2801 = ZDF201.F20103 /*所站集序*/;  --發站集序號
>>~~~~
>>無站所資料:
>>~~~~sql
>>WS2801 = 0;
>>~~~~
>
>~~~~sql
>Select * from ZDF201 
>where ZDF201.F20101/*站所代號*/ = CSF01.CS0108 --到站
>~~~~
>>有站所資料:
>>~~~~sql
>>WS2802 = ZDF201.F20103 /*所站集序*/;  --發站集序號
>>~~~~
>>無站所資料:
>>~~~~sql
>>WS2802 = 0;
>>~~~~
>
>~~~~sql
>WS2803 = CSF01.CS0110 ;    --貨號
>WS2804 = CSF01.CS0109 ;    --明細單號
>WS2805 = CSF01.CS0117 ;    --托運人名稱
>WS2806 = CSF01.CS0119 ;    --收貨人名稱
>WS2807 = CSF01.CS0126 ;    --支付方式
>WS2808 = CSF01.CS0127 ;    --運費選擇碼
>WS2809 = CSF01.CS0122 ;    --件數
>WS2810 = WEGHTP ;          --重量
>WS2811 = TCHRGP ;          --原訂運費
>WS2812 = RCFEE  ;          --原訂接費
>WS2813 = SNFEEP ;          --原訂送費
>
>/*無到著站運費檔*/
>If( CHKL89 == 1 ){
>   WS2814 = 0 ;   --電腦運費
>   WS2815 = 0 ;   --電腦接費
>   WS2816 = 0 ;   --電腦送費
>   WS2817 = 1 ;   --更正單號及說明
>   WS2818 = 0 ;   --每件或代款額
>   WS2819 = 0 ;   --差異運費
>   WS2820 = 0 ;   --差異接費
>   WS2821 = 0 ;   --差異送費
>   WS2822 = '' ;  --運
>   WS2823 = '' ;  --接
>   WS2824 = '' ;  --送
>}
>    
>If( CHKL84 == 1 ){
>   WS2814 = 0 ;   --電腦運費
>   WS2815 = 0 ;   --電腦接費
>   WS2816 = 0 ;   --電腦送費
>   WS2817 = 2 ;   --更正單號及說明
>   WS2818 = GX04 ;--每件或代款額
>   WS2819 = 0 ;   --差異運費
>   WS2820 = 0 ;   --差異接費
>   WS2821 = 0 ;   --差異送費
>   WS2822 = '' ;  --運
>   WS2823 = '' ;  --接
>   WS2824 = '' ;  --送
>}
>
>If( CHKL80 == 1 ){
>   WS2814 = TCHRG1 ;   --電腦運費
>   WS2815 = RCFEE1 ;   --電腦接費
>   WS2816 = SNFEE1 ;   --電腦送費
>
>   *Func : 搬運費(接費)(CHKRCF);
>
>   If(CHKL85 == 1){
>       WS2822 = 1	--運
>       WS2819 = 0	--差異運費
>   }else{
>       WS2822 = '';	--運
>       WS2819 = TCHRG2;	--差異運費
>   }
> 
>   If(CHKL86 == 1){
>      WS2823 = 1 ;	--接
>      WS2820 = 0 ;       --差異接費
>   }else{
>       WS2823 = '';	--接
>       WS2820 = RCFEE2;	--差異接費
>   }
> 
>   If(CHKL87 == 1){
>       If( SNFEET = '止'){	
>           WS2824 = 2 ;	--送
>       }else{
>           WS2824 = 1  ;	--送
>       }
> 	
>       WS2821 = 0 ;	--差異送費
> 
>   }else{
>       WS2824 = ''	--送
>       WS2821 = SNFEE2 ;	--差異送費
>   }
>
>   If(CHKL88 == 1){
>       WS2817 = 3 ;	--更正單號及說明
>       WS2818 = CSHFR2 ;	--每件或代款額
>   }else{
>       WS2817 = '' ;	--更正單號及說明
>       WS2818 = 0 ;	--每件或代款額
>   }
>
>}
>
>
>~~~~

##### 檢核運價合計差異是否＞0及代款是否＜30 (CHKSUB)
>~~~~sql
>
>If(TCHRG2 + RCFEE2 + SNFEE2 != 0){
>   If(CSHFR2 > 0 && CSHFR2 < 30){
>        CHKL88 = 1 ;
>   }
>    *Func : 列印差異表(SUBPRT)
>}
>else{
>   If(SUBTOT == 0 && CSHFR2代款 > 0 && CSHFR2 < 30 ){
>        CHKL88 = 1 ;
>       *Func : 列印差異表(SUBPRT)
>   }
>}
>
>~~~~

##### 檢核每件運價 (CHKGPS)
>~~~~sql
>   
>*Func:計算按件計價的運什費(CSR0284)
>
>If(GX04 != 0){
>    
>       TCHRGP = CSF01.CS0128 ;	--運費
>       RCFEEP = CSF01.CS0129 ;	--接費
>       SNFEEP = CSF01.CS0130 ;	--送費
>       SNFEEP = SNFEEP + CSF01.CS0163 ; --特服費
>       TCHRGP = TCHRGP + CSF01.CS0144 ; --報值費
>       PCKERP = CSF01.CS0132 ;	--送捆工費
>       CSHFRP = CSF01.CS0133 ;	--代款	
>       SUBTAL = TCHRGP + RCFEEP + SNFEEP + PCKERP + CSHFRP ; --總運費
>       GPSUTA = SUBTAL / GPIECP ; --每件運費 = 總運費/件數
>
>   If(GPSUTA < GX04){  --每件運費
>       TCHRGX = '****' ;
>       RCFEEX = '****' ;
>       SNFEEX = '****' ;
>       SUBTOX = '****' ;    
>       CHKL84 = 1;      
>       CHKL85 = 0;
>       CHKL86 = 0;
>       CHKL87 = 0;
>       CHKL88 = 0;
>       CHKL89 = 0; 
> 
>       *Func : 列印差異表(SUBPRT)
>   }
>}else{
>   *Func : 檢核運價合計差異是否＞0及代款是否＜30 (CHKSUB)
>}
>
>~~~~

##### 列印差異表(SUBPRT_2)
>~~~~sql
>CHK90 = 1;
>CHK91 = 1;
>COUNT = COUNT + 1;
>SUBTTT = SUBTTT + WS2819 + WS2820 + WS2821;
>
>*Func : CHECK SUB(CHKSUB_2)
>
>If(WS2802 == RCSTNN ){
>  CHK90 = 0;
>}
>
>If(WS2801 == SNSTNN ){
>  CHK91 = 0;
>}
>
>If( OF == 1 ){
>  CHK90 = 1;
>  CHK91 = 1;
>  OF = 0;
>}
>
>~~~~
>>~~~~sql
>>select * from zdf201
>>where zdf201.F20103 = WS2801 --發站集序號 
>>~~~~
>>
>>有站所資料: 
>>
>>~~~~sql
>>SNSTNP = F20104 ;
>>~~~~
>>
>>無站所資料:
>>
>>~~~~sql
>>SNSTNP = '??' ;
>>~~~~
>
>>~~~~sql
>>select * from zdf201
>>where zdf201.F20103 = WS2802 --到著集序號 
>>~~~~
>>有站所資料: 
>>~~~~sql
>>RCSTNP = F20104 ;
>>~~~~
>>無站所資料:
>>~~~~sql
>>RCSTNP = '??' ;
>>~~~~
>~~~~sql
>PCODEP = '元' ;
>
>If( WS2807 == 0){  --支付方式
>    PCODEP = '到' ;
>}else{
>   If( WS2807 == 1){  --支付方式
>       PCODEP = '現' ;
>   }
>}
>
>SNSTNP = WS2801 ;  --發站集序號
>RCSTNP = WS2802 ;  --到站集序號
>
>~~~~

##### CHECK SUB (CHKSUB_2)
>~~~~sql
> CHK81 = 0;
> CHK80 = 0;
> CHK86 = 0;
> 
> If(WS2817 == 3){ --更正單號及說明
>   CHK80 = 1;
>   CHK88 = 1;
> }else{
>   CHK80 = 0;
>   CHK88 = 0;
> }
> 
> If(WS2822 == 1){ --運
>   CHK85 = 1;
> }else{
>   CHK85 = 0;
> }
> 
> If(WS2823 == 1){ --接
>   CHK85 = 1;
> }else{
>   CHK85 = 0;
> }
> 
> If(WS2824 == 1){ --送
>   CHK87 = 1;
> }else{
>   CHK87 = 0;
> }
> 
> If(WS2824 == 2){ --送
>   CHK81 = 1;
> }else{
>   CHK81 = 0;
> }
> 
> 
>~~~~

<br/>

## :pushpin: Step 2 下載發送運價差異資料(CSR0425)
---
##### 暫存欄位初始化
| Name     | Data            | Text         |
| -------- | --------------- | ------------ |
| S1CNT   | 0               |    所合計差異筆數      |
| S1AMT   | 0            |  所合計差異合計  |
| S2CNT   | 0             |  區合計差異筆數       |
| S2AMT   | 0               |  區合計差異合計    |
| T_CNT   | 0               |  當日總計差異筆數        |
| T_AMT   | 0               |  當日總計差異合計    |
<br/>
#### :arrow_down: 判斷&DM0102是否為9999   
* Y: 全部列印 

    (&DM0102 = 9999):
##### 資料來源
~~~~sql
  SELECT * 
  FROM ZDFLIB.CSF21 
  WHERE CS2100 = &DM0101 
~~~~

* N: 部分列印 
    (&DM0102 <> 9999):
##### 資料來源
~~~~sql
  SELECT * 
  FROM ZDFLIB.CSF21 
  WHERE CS2100 = &DM0101 And CS2153 = &DM0102
~~~~

#### :arrow_down: 資料過濾
   
* 併筆判斷(&OPT1)
    不含併筆(&OPT1 = N) ， 請排除以下資料:
~~~~sql
    WHERE CS2155 NOT IN (
    Select CEC201 
    from CEFC2  /*物流客戶運價主控檔*/
    where CEC205 = 'Y')
~~~~



#### 表頭(#HEAD)
| 報表欄位| 欄位值 |
| ----| ------ |
| 報表編號 |  'CSR0425'      | 
| 報表名稱 |   '運價差異資料下載'| 
| 發送日期 |    &DM0101      | 
| 下載日期 | 當下日期 | 
| 下載時間 |  當下時間  | 

<br/>


#### 明細資料 (#DTL)
| 報表欄位| 欄位值 |
| ----| ------ |
| 發站帶號 |  CS2153      | 
| 發站名稱 |  CS2151        | 
| 到站代號 |  CS2154        | 
| 到站名稱 |  CS2152        | 
| 明細單號 |   W_SHIP| 
| 托運人名稱 | CS2105   | 
| 收貨人 |  CS2106   | 
| 支付 |    W_STS   | 
| 運選 |    CS2108 | 
| 件數 | CS2109     | 
| 重量 |    CS2110    | 
| 原訂運費 |  CS2111  | 
| 原訂接費 |  CS2112                  | 
| 原訂送費 |  CS2113                  | 
| 電腦運費 |  CS2114                  | 
| 電腦接費 |  CS2115                  | 
| 電腦送費 |  CS2116                  |
| 差異運費 |  WW2119                               | 
| 差異接費 |  WW2120                               | 
| 差異送費 |  WW2121                               |
| 更正單號及說明： | CS2117   |
>~~~~sql
>PRTN = 'Y'  ;
>W_SHIP = '' ;
>W_STS = '' ;
>WW2119 = '' ;
>WW2120 = '' ;
>WW2121 = '' ;
>
>If(CS2107 == ' '){  --支付方式
>    W_STS ='原';
>}
>If(CS2107 == '0'){  --支付方式
>    W_STS ='到';
>}
>If(CS2107 == '1'){  --支付方式
>    W_STS ='現';
>}
>If(CS2107 == '6'){  --支付方式
>    W_STS ='悠';
>}
>
>W_SHIP = CS2104 /*訂單明細*/ + CS2103 /*貨號*/
>
>If(CS2111/*原定運費*/ > CS2114/*電腦運費*/){ 
>    WW2119 ='*****';
>}
>
>If(CS2112/*原定接費*/ > CS2115/*電腦接費*/){ 
>    WW2120 ='*****';
>}else{
>    WW2120 = CS2120 ;  --差異接費
>}
>
>If(CS2113/*原定送費*/ > CS2116/*電腦送費*/){ 
>    WW2121 ='*****';
>}else{
>    WW2121 = CS2121 ;  --差異送費
>}
>
>~~~~

 <br/>
#### 表尾(TAIL)

#### 所合計
| 報表欄位| 欄位值 |
| ----| ------ |
| 差異筆數 |  S1CNT      | 
| 差異合計 |  S1AMT     | 

#### 區合計
| 報表欄位| 欄位值 |
| ----| ------ |
| 差異筆數 |  S2CNT      | 
| 差異合計 |  S2AMT     | 

#### 當日總計
| 報表欄位| 欄位值 |
| ----| ------ |
| 差異筆數 |  T_CNT      | 
| 差異合計 |  T_AMT     | 

 <br/>
 
![](https://i.imgur.com/QvOiTgb.png)